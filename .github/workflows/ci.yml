name: ðŸš€ CI Pipeline

on:
  push:
    branches: [main, develop]
    paths-ignore:
      - 'k8s/**'
      - '**.md'
      - 'documentation/**'
      - '.github/workflows/cd.yml'
  pull_request:
    branches: [main, develop]
    paths-ignore:
      - 'k8s/**'
      - '**.md'
      - 'documentation/**'
      - '.github/workflows/cd.yml'

permissions:
  contents: read
  checks: write
  pull-requests: write
  packages: write
  security-events: write
  actions: read
  attestations: write
  id-token: write

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # ================================
  # Tests and Quality
  # ================================
  tests:
    name: ðŸ§ª Quality Assurance
    uses: ./.github/workflows/tests.yml
    with:
      ref: ${{ github.ref }}

  # ================================
  # Coverage Report
  # ================================
  codecov:
    name: ðŸ“Š Coverage Report
    needs: [tests]
    uses: ./.github/workflows/codecov.yml
    with:
      ref: ${{ github.ref }}
    secrets:
      CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  # ================================
  # Docker Build
  # ================================
  docker:
    name: ðŸ“¦ Container Registry
    needs: [tests]
    uses: ./.github/workflows/docker.yml
    with:
      ref: ${{ github.ref }}
      should_deploy: ${{ github.ref == 'refs/heads/main' && github.event_name == 'push' }}
    secrets:
      SECRET_KEY_BASE: ${{ secrets.SECRET_KEY_BASE }}
